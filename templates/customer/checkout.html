{% extends 'base.html' %}
{% load static %}
{% load image_filters %}

{% block title %}Checkout | QuickBite{% endblock %}

{% block content %}
<!--
==============================================
MODERN CHECKOUT PAGE - REDESIGNED
==============================================
Clean, step-by-step checkout experience:

FEATURES:
- Minimalist hero section with progress
- Clean form layout with validation
- Delivery method selection
- Address input with autocomplete
- Payment method options
- Order summary sidebar
- Mobile-responsive design
- Trust indicators

DESIGN PRINCIPLES:
- Clean white cards
- Orange/red accent colors
- Clear step progression
- Intuitive form fields
- Helpful error messages
- Smooth transitions
-->

<!-- Breadcrumb Navigation -->
<div class="bg-gray-50 border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <nav class="flex items-center space-x-2 text-sm">
            <a href="{% url 'customer:home' %}" class="text-gray-500 hover:text-orange-600 transition-colors duration-200 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                Home
            </a>
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <a href="{% url 'customer:cart' %}" class="text-green-600 hover:text-green-700 transition-colors duration-200 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                Cart
            </a>
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-gray-900 font-medium">Checkout</span>
        </nav>
    </div>
</div>

<!-- Hero Section -->
<div class="bg-gradient-to-br from-orange-50 via-white to-red-50 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 mb-2 flex items-center">
                    Checkout
                    <span class="ml-3 inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-800 text-sm font-semibold">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        Secure
                    </span>
                </h1>
                <p class="text-gray-600">Complete your order details</p>
            </div>
            <!-- Progress Steps -->
            <div class="hidden md:flex items-center space-x-4">
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white font-bold shadow-lg">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="ml-2 text-sm font-semibold text-green-600">Cart</span>
                </div>
                <div class="w-16 h-1 bg-orange-500 rounded"></div>
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-10 h-10 rounded-full bg-orange-500 text-white font-bold shadow-lg">
                        2
                    </div>
                    <span class="ml-2 text-sm font-semibold text-orange-600">Checkout</span>
                </div>
                <div class="w-16 h-1 bg-gray-200 rounded"></div>
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-200 text-gray-500 font-bold">
                        3
                    </div>
                    <span class="ml-2 text-sm font-medium text-gray-500">Payment</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <form method="POST" action="{% url 'customer:checkout' %}" 
      id="checkout-form"
      class="grid grid-cols-1 lg:grid-cols-3 gap-8"
      data-promo-applied="{% if breakdown.applied_promo_code %}true{% else %}false{% endif %}"
      data-points-used="{% if breakdown.points_used %}true{% else %}false{% endif %}"
      data-free-delivery="{% if breakdown.free_delivery %}true{% else %}false{% endif %}"
      data-subtotal="{{ breakdown.subtotal }}"
      data-discount-amount="{{ breakdown.discount_amount }}"
      data-points-discount="{% if breakdown.points_discount %}{{ breakdown.points_discount }}{% else %}0{% endif %}">
        {% csrf_token %}
        
        <!-- Checkout Form (Left - 2/3 width) -->
        <div class="lg:col-span-2 space-y-8 order-2 lg:order-1">
            <!--
            ==============================================
            DELIVERY METHOD SECTION
            ==============================================
            Choose between delivery and takeaway
            -->
            <div class="bg-gradient-to-br from-orange-50 via-white to-orange-100 rounded-2xl shadow-lg border border-orange-200 p-6 backdrop-blur-sm hover:shadow-xl transition-all duration-300">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-orange-100 text-orange-600 font-bold mr-3">1</span>
                    Delivery Method
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Delivery Option -->
                    <label class="relative flex items-center p-6 bg-gray-50 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all duration-200">
                        <input type="radio" name="delivery_method" value="delivery" class="sr-only peer" checked>
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <svg class="w-6 h-6 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                                </svg>
                                <span class="text-lg font-bold text-gray-900">Home Delivery</span>
                            </div>
                            <p class="text-sm text-gray-600">Get it delivered to your doorstep</p>
                            <p class="text-sm font-semibold text-orange-600 mt-2">30-45 mins</p>
                        </div>
                        <div class="absolute top-4 right-4 w-5 h-5 rounded-full border-2 border-gray-300 peer-checked:border-orange-600 peer-checked:bg-orange-600 flex items-center justify-center">
                            <svg class="w-3 h-3 text-white hidden peer-checked:block" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </label>
                    
                    <!-- Takeaway Option -->
                    <label class="relative flex items-center p-6 bg-gray-50 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all duration-200">
                        <input type="radio" name="delivery_method" value="takeaway" class="sr-only peer">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <svg class="w-6 h-6 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                </svg>
                                <span class="text-lg font-bold text-gray-900">Takeaway</span>
                            </div>
                            <p class="text-sm text-gray-600">Pick up from restaurant</p>
                            <p class="text-sm font-semibold text-orange-600 mt-2">Ready in 20 mins</p>
                        </div>
                        <div class="absolute top-4 right-4 w-5 h-5 rounded-full border-2 border-gray-300 peer-checked:border-orange-600 peer-checked:bg-orange-600 flex items-center justify-center">
                            <svg class="w-3 h-3 text-white hidden peer-checked:block" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </label>
                </div>
                
                <!-- Delivery Time Selection -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Preferred Delivery Time</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="relative flex items-center justify-center p-3 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all duration-200">
                            <input type="radio" name="delivery_time" value="asap" class="sr-only peer" checked>
                            <span class="text-sm font-medium text-gray-900 peer-checked:text-orange-600">ASAP (25-35 min)</span>
                            <div class="absolute top-2 right-2 w-4 h-4 rounded-full border-2 border-gray-300 peer-checked:border-orange-600 peer-checked:bg-orange-600"></div>
                        </label>
                        <label class="relative flex items-center justify-center p-3 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all duration-200">
                            <input type="radio" name="delivery_time" value="30min" class="sr-only peer">
                            <span class="text-sm font-medium text-gray-900 peer-checked:text-orange-600">30 minutes</span>
                            <div class="absolute top-2 right-2 w-4 h-4 rounded-full border-2 border-gray-300 peer-checked:border-orange-600 peer-checked:bg-orange-600"></div>
                        </label>
                        <label class="relative flex items-center justify-center p-3 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all duration-200">
                            <input type="radio" name="delivery_time" value="1hr" class="sr-only peer">
                            <span class="text-sm font-medium text-gray-900 peer-checked:text-orange-600">1 hour</span>
                            <div class="absolute top-2 right-2 w-4 h-4 rounded-full border-2 border-gray-300 peer-checked:border-orange-600 peer-checked:bg-orange-600"></div>
                        </label>
                        <label class="relative flex items-center justify-center p-3 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all duration-200">
                            <input type="radio" name="delivery_time" value="2hr" class="sr-only peer">
                            <span class="text-sm font-medium text-gray-900 peer-checked:text-orange-600">2 hours</span>
                            <div class="absolute top-2 right-2 w-4 h-4 rounded-full border-2 border-gray-300 peer-checked:border-orange-600 peer-checked:bg-orange-600"></div>
                        </label>
                    </div>
                </div>
            </div>
            
            <!--
            ==============================================
            DELIVERY DETAILS SECTION
            ==============================================
            Combined contact and address information
            -->
            <div class="bg-gradient-to-br from-blue-50 via-white to-blue-100 rounded-2xl shadow-lg border border-blue-200 p-6 backdrop-blur-sm hover:shadow-xl transition-all duration-300">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 font-bold mr-3">2</span>
                    Delivery Details
                </h2>
                
                <!-- Contact Information -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Contact Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                            <input type="text" 
                                   name="customer_name" 
                                   value="{{ user.get_full_name }}"
                                   required
                                   autocomplete="name"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                            <input type="tel" 
                                   name="customer_phone" 
                                   value="{{ user.phone }}"
                                   required
                                   pattern="[0-9]{10}"
                                   placeholder="10-digit mobile number"
                                   autocomplete="tel"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                        
                        <!-- Email field removed - not in CheckoutForm -->
                    </div>
                </div>
                
                <!-- Delivery Address -->
                <div id="delivery-address-section">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Delivery Address
                    </h3>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Street Address *</label>
                            <input type="text" 
                                   id="customer_address"
                                   name="customer_address" 
                                   required
                                   placeholder="House/Flat No., Building Name"
                                   autocomplete="street-address"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                                <input type="text" 
                                       id="city"
                                       name="city" 
                                       required
                                       autocomplete="address-level2"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Postal Code *</label>
                                <input type="text" 
                                       id="postal_code"
                                       name="postal_code" 
                                       required
                                       pattern="[0-9]{6}"
                                       placeholder="6-digit PIN code"
                                       autocomplete="postal-code"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Order Notes (Optional)</label>
                            <textarea name="notes" 
                                      rows="3"
                                      placeholder="E.g., Ring the doorbell, Leave at the door, Extra spicy"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!--
            ==============================================
            DISCOUNTS SECTION (COLLAPSIBLE)
            ==============================================
            Promo codes and loyalty points for discounts
            -->
            <div class="bg-gradient-to-br from-green-50 via-white/90 to-emerald-100 rounded-2xl shadow-lg border border-green-200 overflow-hidden backdrop-blur-md hover:shadow-xl transition-all duration-300">
                <!-- Collapsible Header -->
                <button type="button" 
                        onclick="toggleDiscountsSection()"
                        class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-600 font-bold mr-3">3</span>
                        Discounts & Rewards
                        {% if breakdown.applied_promo_code or breakdown.points_used %}
                        <span class="ml-3 px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">Applied</span>
                        {% endif %}
                    </h2>
                    <svg id="discounts-chevron" class="w-5 h-5 text-gray-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <!-- Collapsible Content -->
                <div id="discounts-content" class="hidden">
                    <div class="px-6 pb-6 space-y-6">
                        <!-- Promo Code Section -->
                        <div class="pt-4 border-t border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                                </svg>
                                Promo Code
                            </h3>
                            
                            {% if breakdown.applied_promo_code %}
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="font-semibold text-green-800">Promo Applied: {{ breakdown.applied_promo_code.code }}</span>
                                    </div>
                                    <form method="POST" action="{% url 'customer:cart_remove_promo' %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="next" value="{% url 'customer:checkout' %}">
                                        <button type="submit" class="text-sm text-red-600 hover:text-red-800 font-medium">Remove</button>
                                    </form>
                                </div>
                                <p class="text-sm text-green-700 mt-1">{{ breakdown.applied_promo_code.description }}</p>
                            </div>
                            {% else %}
                            <form method="POST" action="{% url 'customer:apply_promo_code' %}" class="space-y-3">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{% url 'customer:checkout' %}">
                                <div class="flex gap-3">
                                    <input type="text" 
                                           name="promo_code" 
                                           placeholder="Enter promo code"
                                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <button type="submit" 
                                            class="px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg transition-colors duration-200">
                                        Apply
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600">Try codes like FIRST10, WELCOME20, SAVE5</p>
                            </form>
                            {% endif %}
                        </div>
                        
                        <!-- Loyalty Points Section -->
                        <div class="pt-4 border-t border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                </svg>
                                Loyalty Points
                            </h3>
                            
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="font-semibold text-blue-800">Available Points</span>
                                    <span class="text-xl font-bold text-blue-600">{{ available_points }}</span>
                                </div>
                                <p class="text-sm text-blue-700 mt-1">Use points for instant discounts (1 point = ‚Çπ1)</p>
                            </div>
                            
                            {% if max_points_allowed > 0 %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Redeem Points (Max: {{ max_points_allowed }})
                                </label>
                                <div class="flex gap-3">
                                    <input type="number" 
                                           name="points_to_redeem" 
                                           id="points_to_redeem"
                                           min="0" 
                                           max="{{ max_points_allowed }}"
                                           value="{{ breakdown.points_used|default:0 }}"
                                           placeholder="Enter points to redeem"
                                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <button type="button" 
                                            onclick="updatePointsRedemption()"
                                            class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition-colors duration-200">
                                        Apply
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">Maximum redemption: 50% of order total or 1000 points</p>
                            </div>
                            {% else %}
                            <p class="text-sm text-gray-600">No points available for redemption on this order</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!--
            ==============================================
            PAYMENT METHOD SECTION
            ==============================================
            Payment options
            -->
            <div class="bg-gradient-to-br from-purple-50 via-white to-purple-100 rounded-2xl shadow-lg border border-purple-200 p-6 backdrop-blur-sm hover:shadow-xl transition-all duration-300">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-600 font-bold mr-3">4</span>
                    Payment Method
                </h2>
                
                <div class="space-y-3">
                    <!-- Cash on Delivery -->
                    <label class="flex items-center p-4 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all duration-200">
                        <input type="radio" name="payment_method" value="cod" class="w-5 h-5 text-orange-600 focus:ring-orange-500" checked>
                        <div class="ml-4 flex-1">
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <span class="font-semibold text-gray-900">Cash on Delivery</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Pay with cash when your order arrives</p>
                        </div>
                    </label>
                    
                    <!-- Online Payment -->
                    <label class="flex items-center p-4 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all duration-200">
                        <input type="radio" name="payment_method" value="online" class="w-5 h-5 text-orange-600 focus:ring-orange-500">
                        <div class="ml-4 flex-1">
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                </svg>
                                <span class="font-semibold text-gray-900">Online Payment</span>
                                <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">5% Off</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Pay securely with UPI, Cards, or Net Banking</p>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <!--
        ==============================================
        ORDER SUMMARY SIDEBAR
        ==============================================
        Sticky sidebar with order details
        -->
        <div class="lg:col-span-1 order-1 lg:order-2">
            <div class="bg-gradient-to-br from-gray-50 via-white to-slate-100 rounded-2xl shadow-lg border border-gray-200 p-6 lg:sticky lg:top-24 backdrop-blur-sm hover:shadow-xl transition-all duration-300">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Order Summary</h2>
                
                <!-- Cart Items -->
                <div class="space-y-4 mb-6 max-h-64 overflow-y-auto">
                    {% for item in cart %}
                    <div class="flex gap-3 pb-4 border-b border-gray-100 last:border-0">
                        <img src="{{ item.menu_item|get_menu_item_image:'thumbnail' }}" 
                             alt="{{ item.menu_item.name }}"
                             class="w-16 h-16 rounded-lg object-cover"
                             onerror="this.src='/media/placeholders/food_default.jpg'">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm">{{ item.menu_item.name }}</h4>
                            <p class="text-xs text-gray-600">Qty: {{ item.quantity }}</p>
                            <p class="text-sm font-bold text-gray-900 mt-1">‚Çπ{{ item.total_price }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Price Breakdown -->
                <div class="space-y-3 mb-6 pb-6 border-b border-gray-200">
                    <div class="flex justify-between text-gray-700">
                        <span>Subtotal</span>
                        <span class="font-semibold">‚Çπ{{ breakdown.subtotal }}</span>
                    </div>
                    
                    <!-- Promo Code Discount -->
                    {% if breakdown.discount_amount %}
                    <div class="flex justify-between text-green-600">
                        <span>Promo Discount ({{ breakdown.applied_promo_code.code }})</span>
                        <span class="font-semibold">-‚Çπ{{ breakdown.discount_amount }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Loyalty Points Discount -->
                    {% if breakdown.points_discount %}
                    <div class="flex justify-between text-green-600">
                        <span>Points Discount ({{ breakdown.points_used }} points)</span>
                        <span class="font-semibold">-‚Çπ{{ breakdown.points_discount }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="flex justify-between text-gray-700">
                        <span>Delivery Fee</span>
                        <span class="font-semibold" id="delivery-fee-display">
                            {% if breakdown.free_delivery %}
                                <span class="text-green-600">FREE</span>
                            {% else %}
                                ‚Çπ{{ breakdown.delivery_charge }}
                            {% endif %}
                        </span>
                    </div>
                    
                    <!-- Taxes (GST) -->
                    {% if breakdown.gst_amount %}
                    <div class="flex justify-between text-gray-700">
                        <span>GST (5%)</span>
                        <span class="font-semibold">‚Çπ{{ breakdown.gst_amount }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Restaurant Charges -->
                    {% if breakdown.restaurant_charges %}
                    <div class="flex justify-between text-gray-700">
                        <span>Restaurant Charges</span>
                        <span class="font-semibold">‚Çπ{{ breakdown.restaurant_charges }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex justify-between text-xl font-bold text-gray-900 mb-6">
                    <span>Total</span>
                    <span id="order-total-display">‚Çπ{{ breakdown.final_total }}</span>
                </div>
                
                <!-- Place Order Button -->
                <button type="submit" 
                        id="place-order-btn"
                        onclick="console.log('Button onclick fired!'); return true;"
                        class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white py-4 px-6 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300"
                        style="cursor: pointer; pointer-events: auto;">
                    Place Order
                    <svg class="inline-block w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                
                <!-- Alternative: Manual Submit Button (for testing) -->
                <button type="button"
                        onclick="document.querySelector('form[action*=checkout]').submit();"
                        class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-xl font-semibold text-sm">
                    üîß Manual Submit (Testing Only)
                </button>
                
                <!-- Trust Indicators -->
                <div class="mt-6 space-y-2 text-sm text-gray-600">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>100% Secure payments</span>
                    </div>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>Easy cancellation</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript for dynamic form behavior -->
<script>
/**
 * Toggle delivery address section based on delivery method
 * Shows address fields only when delivery is selected
 * Also manages required attributes to prevent form validation blocking
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('Checkout page JavaScript initialized');
    
    const deliveryRadios = document.querySelectorAll('input[name="delivery_method"]');
    const addressSection = document.getElementById('delivery-address-section');
    const addressFields = [
        'customer_address',
        'city', 
        'postal_code'
    ];
    
    /**
     * Update address field visibility and required attributes
     * based on selected delivery method
     * Also updates delivery fee and total amount dynamically
     */
    function updateAddressFields() {
        const selectedRadio = document.querySelector('input[name="delivery_method"]:checked');
        if (!selectedRadio) {
            console.error('No delivery method selected');
            return;
        }
        
        const selectedMethod = selectedRadio.value;
        const isDelivery = selectedMethod === 'delivery';
        
        console.log('Delivery method changed to:', selectedMethod);
        
        // Show/hide address section
        if (addressSection) {
            if (isDelivery) {
                addressSection.style.display = 'block';
                console.log('Address section shown');
            } else {
                addressSection.style.display = 'none';
                console.log('Address section hidden');
            }
        }
        
        // Manage required attributes to prevent validation blocking
        let fieldsUpdated = 0;
        addressFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                if (isDelivery) {
                    field.setAttribute('required', 'required');
                } else {
                    field.removeAttribute('required');
                }
                fieldsUpdated++;
            } else {
                console.warn('Address field not found:', fieldId);
            }
        });
        console.log('Updated required attributes for', fieldsUpdated, 'fields');
        
        // Update delivery fee and total dynamically
        updateDeliveryFeeDisplay(isDelivery);
    }
    
    /**
     * Update delivery fee display based on delivery method
     * Takeaway = FREE, Delivery = ‚Çπ40 (unless promo code gives free delivery)
     * 
     * @param {boolean} isDelivery - True if delivery selected, false if takeaway
     */
    function updateDeliveryFeeDisplay(isDelivery) {
        const deliveryFeeDisplay = document.getElementById('delivery-fee-display');
        const orderTotalDisplay = document.getElementById('order-total-display');
        const checkoutForm = document.querySelector('form[action*="checkout"]');
        
        if (!deliveryFeeDisplay || !orderTotalDisplay || !checkoutForm) {
            console.warn('Required elements not found for delivery fee update');
            return;
        }
        
        // Get pricing data from form data attributes
        const subtotal = parseFloat(checkoutForm.dataset.subtotal) || 0;
        const discountAmount = parseFloat(checkoutForm.dataset.discountAmount) || 0;
        const pointsDiscount = parseFloat(checkoutForm.dataset.pointsDiscount) || 0;
        const hasFreeDeliveryPromo = checkoutForm.dataset.freeDelivery === 'true';
        
        // Calculate delivery charge
        let deliveryCharge = 0;
        let deliveryFeeHTML = '';
        
        if (isDelivery) {
            if (hasFreeDeliveryPromo) {
                // Promo code gives free delivery
                deliveryFeeHTML = '<span class="text-green-600">FREE</span>';
                deliveryCharge = 0;
            } else {
                // Standard delivery charge
                deliveryFeeHTML = '‚Çπ40';
                deliveryCharge = 40;
            }
        } else {
            // Takeaway - always free
            deliveryFeeHTML = '<span class="text-green-600 font-semibold">FREE</span>';
            deliveryCharge = 0;
        }
        
        // Update delivery fee display with animation
        deliveryFeeDisplay.style.transition = 'all 0.3s ease';
        deliveryFeeDisplay.style.transform = 'scale(1.1)';
        deliveryFeeDisplay.innerHTML = deliveryFeeHTML;
        
        setTimeout(function() {
            deliveryFeeDisplay.style.transform = 'scale(1)';
        }, 300);
        
        // Calculate and update total
        const newTotal = subtotal - discountAmount - pointsDiscount + deliveryCharge;
        
        // Update total display with animation
        orderTotalDisplay.style.transition = 'all 0.3s ease';
        orderTotalDisplay.style.transform = 'scale(1.1)';
        orderTotalDisplay.style.color = '#f97316'; // Orange color
        orderTotalDisplay.textContent = '‚Çπ' + newTotal.toFixed(2);
        
        setTimeout(function() {
            orderTotalDisplay.style.transform = 'scale(1)';
            orderTotalDisplay.style.color = '#111827'; // Back to gray-900
        }, 300);
        
        console.log('Updated delivery fee:', deliveryCharge, 'New total:', newTotal);
    }
    
    // Set up event listeners for delivery method radio buttons
    if (deliveryRadios.length > 0) {
        deliveryRadios.forEach(radio => {
            radio.addEventListener('change', updateAddressFields);
        });
        console.log('Event listeners attached to', deliveryRadios.length, 'radio buttons');
    } else {
        console.error('No delivery method radio buttons found');
    }
    
    // Initialize on page load
    updateAddressFields();
    
    // Test button click responsiveness and force submission if needed
    const placeOrderBtn = document.getElementById('place-order-btn');
    if (placeOrderBtn) {
        placeOrderBtn.addEventListener('click', function(e) {
            console.log('üîò Place Order button clicked!');
            console.log('Button type:', placeOrderBtn.type);
            console.log('Button disabled:', placeOrderBtn.disabled);
            console.log('Button parent form:', placeOrderBtn.form);
            
            // Check if button is inside a form
            if (!placeOrderBtn.form) {
                console.error('‚ùå Button is not inside a form!');
                alert('Error: Button is not inside a form. Please contact support.');
                return;
            }
            
            console.log('Form action:', placeOrderBtn.form.action);
            console.log('Form method:', placeOrderBtn.form.method);
        });
        console.log('‚úÖ Place Order button found and click listener attached');
    } else {
        console.error('‚ùå Place Order button not found');
    }
    
    // Add comprehensive form submission debugging
    const checkoutForm = document.querySelector('form[action*="checkout"]');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            console.log('=== FORM SUBMISSION DEBUG START ===');
            console.log('Form submission started');
            
            // Check all form fields
            const formData = new FormData(checkoutForm);
            console.log('Form data submitted:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            // Check required fields
            const requiredFields = checkoutForm.querySelectorAll('[required]');
            console.log('Required fields found:', requiredFields.length);
            requiredFields.forEach(field => {
                console.log(`  Required: ${field.name || field.id} = ${field.value}`);
            });
            
            // Check specific critical fields
            const deliveryMethod = document.querySelector('input[name="delivery_method"]:checked')?.value;
            const deliveryTime = document.querySelector('input[name="delivery_time"]:checked')?.value;
            const paymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;
            const customerName = document.querySelector('input[name="customer_name"]')?.value;
            const customerPhone = document.querySelector('input[name="customer_phone"]')?.value;
            
            console.log('Critical field values:');
            console.log('  Delivery method:', deliveryMethod);
            console.log('  Delivery time:', deliveryTime);
            console.log('  Payment method:', paymentMethod);
            console.log('  Customer name:', customerName);
            console.log('  Customer phone:', customerPhone);
            
            // Check if any critical fields are missing
            if (!deliveryMethod) console.error('‚ùå Delivery method not selected');
            if (!deliveryTime) console.error('‚ùå Delivery time not selected');
            if (!paymentMethod) console.error('‚ùå Payment method not selected');
            if (!customerName) console.error('‚ùå Customer name not filled');
            if (!customerPhone) console.error('‚ùå Customer phone not filled');
            
            // Check if form is valid
            const isValid = checkoutForm.checkValidity();
            console.log('Browser form validation result:', isValid);
            
            if (!isValid) {
                console.error('‚ùå Form validation failed');
                e.preventDefault();
                
                // Find and log invalid fields
                const invalidFields = checkoutForm.querySelectorAll(':invalid');
                console.log('Invalid fields:', invalidFields.length);
                invalidFields.forEach(field => {
                    console.error(`  ‚ùå Invalid field: ${field.name || field.id} - ${field.validationMessage}`);
                });
                
                // Show browser validation messages
                checkoutForm.reportValidity();
                console.log('=== FORM SUBMISSION DEBUG END (VALIDATION FAILED) ===');
                return false;
            }
            
            console.log('‚úÖ Form appears valid, submitting to server...');
            console.log('=== FORM SUBMISSION DEBUG END (SUCCESS) ===');
        });
        console.log('‚úÖ Form submission listener attached successfully');
    } else {
        console.error('‚ùå Checkout form not found on page');
    }
});

/**
 * Toggle discounts section (collapsible)
 * Shows/hides promo code and loyalty points sections
 */
function toggleDiscountsSection() {
    const content = document.getElementById('discounts-content');
    const chevron = document.getElementById('discounts-chevron');
    
    if (content.classList.contains('hidden')) {
        // Show section
        content.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    } else {
        // Hide section
        content.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

/**
 * Update loyalty points redemption
 * Submits points redemption and updates order summary
 */
function updatePointsRedemption() {
    const pointsInput = document.getElementById('points_to_redeem');
    const pointsToRedeem = parseInt(pointsInput.value) || 0;
    const maxPoints = parseInt(pointsInput.max);
    
    if (pointsToRedeem < 0) {
        alert('Points cannot be negative');
        pointsInput.value = 0;
        return;
    }
    
    if (pointsToRedeem > maxPoints) {
        alert(`Maximum ${maxPoints} points can be redeemed`);
        pointsInput.value = maxPoints;
        return;
    }
    
    // Submit form to update points redemption
    // This will trigger the checkout view POST handling
    const form = document.querySelector('form');
    form.submit();
}

/**
 * Handle points input Enter key
 */
const pointsInput = document.getElementById('points_to_redeem');
if (pointsInput) {
    pointsInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            updatePointsRedemption();
        }
    });
}

/**
 * Auto-expand discounts section if promo or points are applied
 */
document.addEventListener('DOMContentLoaded', function() {
    // Check if any discounts are applied and auto-expand the section
    const form = document.querySelector('form');
    const hasPromoApplied = form.dataset.promoApplied === 'true';
    const hasPointsUsed = form.dataset.pointsUsed === 'true';
    
    if (hasPromoApplied || hasPointsUsed) {
        toggleDiscountsSection();
    }
});
</script>

{% endblock %}

{% endblock %}
