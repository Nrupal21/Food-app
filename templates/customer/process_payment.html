{% extends 'base.html' %}
{% load static %}

{% block title %}Payment Unavailable - Food Ordering System{% endblock %}

{% block content %}
<!-- 
    ============================================
    PAYMENT UNAVAILABLE PAGE
    ============================================
    This page is shown when users try to access
    the payment processing page after online payments
    have been disabled.
    
    Online payments have been temporarily disabled.
    Only Cash on Delivery is now available.
-->
<div class="min-h-screen bg-gradient-to-br from-rose-50 via-pink-50 to-purple-50 py-12 flex items-center">
    <div class="max-w-2xl mx-auto px-4">
        
        <!-- Payment Unavailable Message -->
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-6">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
            </div>
            
            <h1 class="text-2xl font-bold text-gray-900 mb-3">Online Payments Temporarily Unavailable</h1>
            
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                <p class="text-amber-800 text-sm">
                    <strong>Currently accepting Cash on Delivery only</strong>
                </p>
            </div>
            
            <p class="text-gray-600 mb-8">
                We're currently only accepting Cash on Delivery for all orders. 
                Please return to checkout to complete your order with COD.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{% url 'customer:checkout' %}" 
                   class="inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600 text-white font-medium rounded-lg transition-all duration-200 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Return to Checkout
                </a>
                
                <a href="{% url 'customer:home' %}" 
                   class="inline-flex items-center justify-center px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-all duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    Back to Home
                </a>
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-200">
                <p class="text-xs text-gray-500">
                    If you have any questions, please contact our customer support.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
                
                <div class="pt-3 border-t border-gray-200">
                    <div class="flex justify-between">
                        <span class="text-base font-bold text-gray-900">Total Amount:</span>
                        <span class="text-2xl font-bold text-rose-600">₹{{ order.total_amount }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Payment Instructions -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6">
            <div class="flex items-start space-x-3">
                <svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <div>
                    <h3 class="text-sm font-bold text-blue-900 mb-1">Payment Instructions</h3>
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>• Click "Proceed to Pay" to open Razorpay checkout</li>
                        <li>• Choose your preferred payment method (UPI, Cards, Wallets, etc.)</li>
                        <li>• Complete the payment securely</li>
                        <li>• You'll be redirected to order confirmation page</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Payment Button -->
        <div class="text-center">
            <button id="pay-button" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-5 rounded-xl font-bold text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl flex items-center justify-center group">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                Proceed to Pay ₹{{ order.total_amount }}
                <svg class="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
            </button>
            
            <!-- Back to Checkout Link -->
            <a href="{% url 'customer:checkout' %}" class="inline-block mt-4 text-gray-600 hover:text-gray-900 text-sm">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
                </svg>
                Cancel and go back
            </a>
        </div>
        
        <!-- Security Badges -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <p class="text-center text-xs text-gray-500 mb-3">Payment secured by</p>
            <div class="flex justify-center items-center space-x-6">
                <div class="text-center">
                    <div class="flex items-center justify-center w-12 h-12 bg-blue-100 rounded-lg mx-auto mb-2">
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <p class="text-xs font-semibold text-gray-700">256-bit SSL</p>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center w-12 h-12 bg-purple-100 rounded-lg mx-auto mb-2">
                        <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <p class="text-xs font-semibold text-gray-700">PCI DSS</p>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center w-12 h-12 bg-green-100 rounded-lg mx-auto mb-2">
                        <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <p class="text-xs font-semibold text-gray-700">Verified</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 
    ============================================
    RAZORPAY CHECKOUT SCRIPT
    ============================================
    Integrates Razorpay payment gateway for secure payment processing
-->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    /**
     * Initialize Razorpay payment checkout
     * Handles payment processing and verification
     */
    document.getElementById('pay-button').addEventListener('click', function(e) {
        e.preventDefault();
        
        // Razorpay configuration options
        var options = {
            "key": "{{ razorpay_key_id }}", // Razorpay API Key
            "amount": "{{ amount_in_paise }}", // Amount in paise
            "currency": "INR",
            "name": "Tetech Food Ordering",
            "description": "Order Payment #{{ order.order_id|truncatewords:2 }}",
            "image": "{% static 'img/logo.png' %}", // Your logo
            "order_id": "{{ razorpay_order_id }}", // Razorpay order ID
            "handler": function (response) {
                // Payment successful - verify signature
                verifyPayment(response);
            },
            "prefill": {
                "name": "{{ order.customer_name }}",
                "contact": "{{ order.customer_phone }}",
                "email": "{{ request.user.email }}"
            },
            "notes": {
                "order_id": "{{ order.order_id }}",
                "customer_name": "{{ order.customer_name }}"
            },
            "theme": {
                "color": "#F43F5E" // Rose-500
            },
            "modal": {
                "ondismiss": function() {
                    // Payment cancelled by user
                    console.log('Payment cancelled by user');
                }
            }
        };
        
        // Open Razorpay checkout
        var rzp = new Razorpay(options);
        rzp.open();
    });
    
    /**
     * Verify payment with server
     * Sends payment details to backend for signature verification
     * 
     * @param {Object} response - Razorpay payment response
     */
    function verifyPayment(response) {
        // Show loading indicator
        const payButton = document.getElementById('pay-button');
        payButton.disabled = true;
        payButton.innerHTML = `
            <svg class="animate-spin w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Verifying payment...
        `;
        
        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Send payment details to server for verification
        fetch("{% url 'customer:verify_payment' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: new URLSearchParams({
                'razorpay_payment_id': response.razorpay_payment_id,
                'razorpay_order_id': response.razorpay_order_id,
                'razorpay_signature': response.razorpay_signature,
                'order_id': "{{ order.order_id }}"
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Payment verified successfully - redirect to success page
                window.location.href = data.redirect_url;
            } else {
                // Payment verification failed
                alert('Payment verification failed: ' + data.error);
                payButton.disabled = false;
                payButton.innerHTML = 'Proceed to Pay ₹{{ order.total_amount }}';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred during payment verification. Please contact support.');
            payButton.disabled = false;
            payButton.innerHTML = 'Proceed to Pay ₹{{ order.total_amount }}';
        });
    }
</script>

<!-- Hidden CSRF Token -->
<form style="display:none;">
    {% csrf_token %}
</form>
{% endblock %}
