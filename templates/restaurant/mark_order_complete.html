{% extends 'restaurant/restaurant_base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    /* Mark order complete custom styles */
    .order-summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    /* Payment method card styles - animations removed */
    .payment-method-card {
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    .payment-method-card.selected {
        border-color: #4F46E5;
        background: linear-gradient(to right, #EEF2FF, #F9FAFB);
    }
    
    .payment-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 24px;
    }
    
    .payment-icon.cash {
        background: #10B981;
        color: white;
    }
    
    .payment-icon.card {
        background: #3B82F6;
        color: white;
    }
    
    .payment-icon.upi {
        background: #8B5CF6;
        color: white;
    }
    
    .confirmation-section {
        background: #FEF3C7;
        border: 2px solid #F59E0B;
        border-radius: 0.5rem;
    }
    
    .total-display {
        font-size: 2.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .item-row {
        transition: background-color 0.2s ease;
    }
    
    .item-row:hover {
        background-color: #F9FAFB;
    }
    
    /* Pulse animation removed to prevent disappearing effect */
    .pulse-animation {
        /* Animation disabled */
    }
</style>
{% endblock %}

{% block restaurant_content %}
<div class="min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        üí≥ {{ title }}
                    </h1>
                    <p class="mt-2 text-gray-600">
                        Complete order and process payment
                    </p>
                </div>
                <a href="{% url 'restaurant:table_orders_list' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    ‚Üê Back to Orders
                </a>
            </div>
        </div>

        <!-- Order Summary Card -->
        <div class="order-summary-card rounded-lg shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <span class="text-sm opacity-90">Order ID</span>
                    <p class="font-bold text-lg">#{{ order.order_id|slice:":8" }}</p>
                </div>
                {% if order.table %}
                <div>
                    <span class="text-sm opacity-90">Table</span>
                    <p class="font-bold text-lg">Table {{ order.table.table_number }}</p>
                </div>
                {% endif %}
                <div>
                    <span class="text-sm opacity-90">Customer</span>
                    <p class="font-bold text-lg">{{ order.customer_name }}</p>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-white border-opacity-30">
                <div class="flex justify-between items-center">
                    <span class="text-lg opacity-90">Total Amount:</span>
                    <span class="total-display">‚Çπ{{ order.total_amount }}</span>
                </div>
            </div>
        </div>

        <form method="post" id="complete-order-form">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Order Details -->
                <div class="lg:col-span-2">
                    <!-- Order Items -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            üìã Order Items
                        </h3>
                        
                        <div class="space-y-3">
                            {% for item in order.items.all %}
                            <div class="item-row flex justify-between items-center p-3 rounded-lg border border-gray-200">
                                <div class="flex-1">
                                    <h4 class="font-medium text-gray-900">{{ item.menu_item.name }}</h4>
                                    {% if item.notes %}
                                    <p class="text-sm text-gray-500 mt-1">üìù {{ item.notes }}</p>
                                    {% endif %}
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-gray-900">{{ item.quantity }}x</p>
                                    <p class="text-sm text-gray-500">‚Çπ{{ item.price }} each</p>
                                    <p class="font-bold text-green-600">‚Çπ{{ item.menu_item.price|mul:item.quantity }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Order Total Breakdown -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="space-y-2">
                                {% if order.discount_amount and order.discount_amount > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Subtotal:</span>
                                    <span class="font-medium">‚Çπ{{ order.total_amount|add:order.discount_amount }}</span>
                                </div>
                                <div class="flex justify-between text-sm text-green-600">
                                    <span>Discount{% if order.promo_code %} ({{ order.promo_code.code }}){% endif %}:</span>
                                    <span class="font-medium">-‚Çπ{{ order.discount_amount }}</span>
                                </div>
                                {% endif %}
                                <div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200">
                                    <span>Final Total:</span>
                                    <span class="text-green-600">‚Çπ{{ order.total_amount }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Special Instructions -->
                    {% if order.notes %}
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            üìù Special Instructions
                        </h3>
                        <p class="text-gray-700 bg-yellow-50 p-3 rounded border border-yellow-200">
                            {{ order.notes }}
                        </p>
                    </div>
                    {% endif %}

                    <!-- Payment Method Selection -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            üí≥ Payment Method
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">
                            Select how the customer paid for this order
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Cash Payment -->
                            <div class="payment-method-card bg-white border-2 border-gray-200 rounded-lg p-4" 
                                 onclick="selectPaymentMethod(this, 'cod')">
                                <div class="text-center">
                                    <div class="payment-icon cash mx-auto mb-3">
                                        üíµ
                                    </div>
                                    <h4 class="font-semibold text-gray-900">Cash</h4>
                                    <p class="text-sm text-gray-500 mt-1">Physical cash payment</p>
                                    <input type="radio" 
                                           name="payment_method" 
                                           value="cod" 
                                           class="hidden" 
                                           {% if order.payment_method == 'cod' %}checked{% endif %}>
                                </div>
                            </div>
                            
                            <!-- Card Payment -->
                            <div class="payment-method-card bg-white border-2 border-gray-200 rounded-lg p-4" 
                                 onclick="selectPaymentMethod(this, 'online')">
                                <div class="text-center">
                                    <div class="payment-icon card mx-auto mb-3">
                                        üí≥
                                    </div>
                                    <h4 class="font-semibold text-gray-900">Card</h4>
                                    <p class="text-sm text-gray-500 mt-1">Credit/Debit card</p>
                                    <input type="radio" 
                                           name="payment_method" 
                                           value="online" 
                                           class="hidden"
                                           {% if order.payment_method == 'online' %}checked{% endif %}>
                                </div>
                            </div>
                            
                            <!-- UPI Payment -->
                            <div class="payment-method-card bg-white border-2 border-gray-200 rounded-lg p-4" 
                                 onclick="selectPaymentMethod(this, 'upi')">
                                <div class="text-center">
                                    <div class="payment-icon upi mx-auto mb-3">
                                        üì±
                                    </div>
                                    <h4 class="font-semibold text-gray-900">UPI</h4>
                                    <p class="text-sm text-gray-500 mt-1">PhonePe, GPay, etc.</p>
                                    <input type="radio" 
                                           name="payment_method" 
                                           value="upi" 
                                           class="hidden">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Confirmation Section -->
                    <div class="confirmation-section rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold text-yellow-900 mb-4">
                            ‚ö†Ô∏è Confirmation Required
                        </h3>
                        <p class="text-sm text-yellow-800 mb-4">
                            Please confirm that you have received payment of <strong>‚Çπ{{ order.total_amount }}</strong> 
                            from the customer before marking this order as complete.
                        </p>
                        
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="payment_received" 
                                   name="payment_received" 
                                   class="h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-yellow-300 rounded"
                                   required>
                            <label for="payment_received" class="ml-2 block text-sm text-yellow-900">
                                I confirm that payment has been received
                            </label>
                        </div>
                    </div>

                    <!-- Order Status -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            üìä Order Status
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Current Status:</span>
                                <span class="px-2 py-1 text-xs rounded-full {{ order.get_status_display_class }}">
                                    {{ order.get_status_display }}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Payment Status:</span>
                                <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">
                                    {{ order.get_payment_status_display }}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Order Time:</span>
                                <span class="text-sm font-medium">{{ order.created_at|date:"h:i A" }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            ‚ö° Quick Actions
                        </h3>
                        <div class="space-y-3">
                            <a href="{% url 'restaurant:print_final_bill' order.order_id %}" 
                               target="_blank"
                               class="w-full flex items-center justify-center px-4 py-2 bg-purple-500 text-white font-medium rounded-lg hover:bg-purple-600 transition duration-200">
                                üßæ Print Final Bill
                            </a>
                            <a href="{% url 'restaurant:order_detail' order.order_id %}" 
                               class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition duration-200">
                                üëÅÔ∏è View Order Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-between">
                <a href="{% url 'restaurant:table_orders_list' %}" 
                   class="px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition duration-200">
                    Cancel
                </a>
                <button type="submit" 
                        id="complete-btn"
                        class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    ‚úÖ Mark Order as Complete
                </button>
            </div>
        </form>
    </div>
</div>

<script>
/**
 * Mark order complete JavaScript functionality
 * Handles payment method selection and form validation
 */
document.addEventListener('DOMContentLoaded', function() {
    // Initialize payment method selection
    initializePaymentMethods();
    
    // Handle confirmation checkbox
    const confirmationCheckbox = document.getElementById('payment_received');
    const submitButton = document.getElementById('complete-btn');
    
    confirmationCheckbox.addEventListener('change', function() {
        submitButton.disabled = !this.checked;
    });
});

/**
 * Initialize payment method selection
 */
function initializePaymentMethods() {
    // Select the currently checked payment method
    const checkedRadio = document.querySelector('input[name="payment_method"]:checked');
    if (checkedRadio) {
        const card = checkedRadio.closest('.payment-method-card');
        if (card) {
            card.classList.add('selected');
        }
    }
}

/**
 * Select payment method
 */
window.selectPaymentMethod = function(card, method) {
    // Remove selected class from all cards
    document.querySelectorAll('.payment-method-card').forEach(c => {
        c.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    card.classList.add('selected');
    
    // Check the radio button
    const radio = card.querySelector('input[type="radio"]');
    if (radio) {
        radio.checked = true;
    }
    
    // Add visual feedback
    showPaymentMethodFeedback(method);
};

/**
 * Show payment method feedback
 */
function showPaymentMethodFeedback(method) {
    const feedbackMessages = {
        'cod': 'Cash payment selected',
        'online': 'Card payment selected',
        'upi': 'UPI payment selected'
    };
    
    // Create temporary feedback element
    const feedback = document.createElement('div');
    feedback.className = 'fixed top-4 right-4 px-4 py-3 bg-blue-500 text-white rounded-lg shadow-lg z-50';
    feedback.textContent = feedbackMessages[method] || 'Payment method selected';
    
    document.body.appendChild(feedback);
    
    // Remove after 2 seconds
    setTimeout(() => {
        feedback.remove();
    }, 2000);
}

/**
 * Form submission validation
 */
document.getElementById('complete-order-form').addEventListener('submit', function(e) {
    const confirmationCheckbox = document.getElementById('payment_received');
    const submitButton = document.getElementById('complete-btn');
    
    if (!confirmationCheckbox.checked) {
        e.preventDefault();
        alert('Please confirm that payment has been received.');
        return false;
    }
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = 'Processing...';
    
    // Add confirmation dialog
    const confirmed = confirm('Are you sure you want to mark this order as complete? This action cannot be undone.');
    if (!confirmed) {
        e.preventDefault();
        submitButton.disabled = false;
        submitButton.innerHTML = '‚úÖ Mark Order as Complete';
        return false;
    }
});

/**
 * Add multiplication filter for Django template
 */
document.addEventListener('DOMContentLoaded', function() {
    // This is a workaround for Django template multiplication
    // In a real implementation, you would handle this in the view
    console.log('Order completion page loaded');
});
</script>

<!-- Custom Django Template Filter (Add to your template tags) -->
<!-- 
This template uses a custom filter `mul` for multiplication.
Add this to your restaurant/templatetags/custom_filters.py:

from django import template

register = template.Library()

@register.filter
def mul(value, arg):
    try:
        return float(value) * float(arg)
    except (ValueError, TypeError):
        return ''
-->
{% endblock %}
